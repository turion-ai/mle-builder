name: Dynamic API Image Builder

on:
  workflow_dispatch: # Use manual trigger for controlled runs

jobs:
  # Job 1: Fetch data from the API and set up the matrix
  fetch_data:
    runs-on: ubuntu-latest
    outputs:
      build_matrix: ${{ steps.get_matrix.outputs.build_matrix }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies (requests for API call)
        run: pip install requests

      - name: Fetch and Prepare Matrix Data
        id: get_matrix
        run: |
          python - <<EOF
          import requests
          import json
          import sys
          import os

          API_URL = "https://api.moneyslastexam.com/attempts/"

          try:
              # Fetch the list of objects from your endpoint
              response = requests.get(API_URL)
              response.raise_for_status()
              matrix_json = response.json()
              
              # Set the output variable for the next job using environment file
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"build_matrix={matrix_json}\n")

          except requests.RequestException as e:
              print(f"Error fetching data from API: {e}", file=sys.stderr)
              sys.exit(1)
          
          EOF

  # Job 2: Run parallel builds using the matrix
  build_and_push:
    needs: fetch_data # Depends on the data being fetched
    runs-on: ubuntu-latest

    # Configure the matrix strategy using the output from the first job
    strategy:
      fail-fast: false # Allows all builds to complete even if one fails
      matrix:
        matrix_item: ${{ fromJson(needs.fetch_data.outputs.build_matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # You must use a secret token for registry login
      - name: Log in to Container Registry (e.g., Docker Hub)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- Critical Step: Dynamic Content Generation ---
      - name: Inject Dynamic Code into main.py
        shell: bash
        env:
          # Use the 'code_content' from the current matrix item
          DYNAMIC_CODE: ${{ matrix.matrix_item.code }}
        run: |
          # Create the full path for the main.py file based on your repo structure
          MAIN_FILE_PATH="backend/app/main.py"
          
          # The DYNAMIC_CODE variable contains base64-encoded Python code from the API.
          # Decode and write it to the file.
          echo "$DYNAMIC_CODE" | base64 -d > "$MAIN_FILE_PATH"
          echo "Successfully wrote dynamic code to $MAIN_FILE_PATH for build ${{ matrix.matrix_item.arch }}"

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: fordnox/moneyslastexam_${{ matrix.matrix_item.arch }}:latest
          cache-from: type=gha # Use GitHub Actions caching